<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Spotlight</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap");

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            text-wrap: balance;
        }

        :root {
            --font: "Segoe UI Variable", "Inter", -apple-system, system-ui,
                sans-serif;
            --primary: #c979ee;
            --accent1: #74bcd6;
            --accent2: #ef788c;
            --background: #e7e7fb;
            --highlight: #eb7fc6;
            --text-primary: rgba(30, 30, 40, 0.95);
            --text-secondary: rgba(30, 30, 40, 0.55);
            --text-tertiary: rgba(30, 30, 40, 0.40);
            --border-subtle: rgba(201, 121, 238, 0.15);
            --hover-bg: rgba(201, 121, 238, 0.08);
            --active-bg: rgba(201, 121, 238, 0.12);
            --accent: var(--primary);
            --accent-glow: rgba(201, 121, 238, 0.4);
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            background: transparent;
            font-family: var(--font);
            color: var(--text-primary);
            -webkit-app-region: drag;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body.gemini-mode .spotlight {
            position: relative;
            background:
                linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)) padding-box,
                linear-gradient(90deg,
                    #74bcd6 0%,
                    #a855f7 25%,
                    #ef788c 50%,
                    #c979ee 75%,
                    #74bcd6 100%) border-box;
            background-size: 100% 100%, 300% 100%;
            border: 3px solid transparent;
            border-radius: 18px;
            animation: ai-border-flow 3s linear infinite;
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            box-shadow:
                0 0 20px rgba(168, 85, 247, 0.25),
                0 0 40px rgba(116, 188, 214, 0.15),
                0 8px 32px rgba(168, 85, 247, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes ai-border-flow {
            0% {
                background-position: 0% 50%, 0% 50%;
            }

            100% {
                background-position: 0% 50%, 300% 50%;
            }
        }

        body.gemini-mode .spotlight::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 15px;
            background: linear-gradient(135deg,
                    rgba(116, 188, 214, 0.06) 0%,
                    rgba(168, 85, 247, 0.04) 50%,
                    rgba(239, 120, 140, 0.06) 100%);
            pointer-events: none;
            animation: ai-ambient-pulse 4s ease-in-out infinite alternate;
            z-index: 0;
        }

        @keyframes ai-ambient-pulse {
            0% {
                opacity: 0.4;
            }

            100% {
                opacity: 0.8;
            }
        }

        .spotlight {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100% !important;
            box-sizing: border-box;
            border-radius: 15px;
            overflow: hidden;
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.98) 0%,
                    rgba(231, 231, 251, 0.95) 50%,
                    rgba(255, 255, 255, 0.98) 100%);
            backdrop-filter: blur(20px);
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1),
                border-radius 0.5s cubic-bezier(0.16, 1, 0.3, 1),
                background 0.5s cubic-bezier(0.33, 1, 0.68, 1),
                box-shadow 0.5s cubic-bezier(0.33, 1, 0.68, 1);
            box-shadow: 0 8px 32px rgba(201, 121, 238, 0.1), 0 0 0 1px rgba(201, 121, 238, 0.15);
        }

        .results-wrapper {
            max-height: 450px;
            overflow-y: auto;
            height: auto;
        }

        .results-wrapper:empty,
        .results-wrapper.collapsed {
            display: none;
            height: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        .search-wrapper {
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 14px;
            min-height: 58px;
            position: relative;
        }

        .search-icon {
            width: 34px;
            height: 34px;
            opacity: 1;
            flex-shrink: 0;
            position: relative;
            transition: all 0.5s var(--ease-out),
                transform 0.5s var(--ease-out),
                opacity 0.5s var(--ease-out);
        }

        .icon-wrapper {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1),
                opacity 0.6s cubic-bezier(0.33, 1, 0.68, 1),
                transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .icon-wrapper.svg-wrapper {
            opacity: 1;
            transform: scale(1) rotate(0deg) translateY(0);
        }

        .icon-wrapper.img-wrapper {
            opacity: 0;
            transform: scale(0.5) rotate(-180deg) translateY(20px);
        }

        body.gemini-mode .icon-wrapper.svg-wrapper {
            opacity: 0;
            transform: scale(0.5) rotate(-180deg) translateY(-40px);
        }

        body.gemini-mode .icon-wrapper.img-wrapper {
            opacity: 1;
            transform: scale(1) rotate(0deg) translateY(0);
        }

        body.google-mode .icon-wrapper.svg-wrapper {
            opacity: 1;
            transform: scale(1) rotate(0deg) translateY(0);
        }

        body.google-mode .icon-wrapper.img-wrapper {
            opacity: 0;
            transform: scale(0.5) rotate(-180deg) translateY(20px);
        }



        @keyframes ai-logo-breathe {

            0%,
            100% {
                transform: scale(1);
            }

            25% {
                transform: scale(1.12);
            }

            50% {
                transform: scale(1.05);
            }

            75% {
                transform: scale(1.09);
            }
        }

        @keyframes ai-logo-pulse {

            0%,
            100% {
                filter: drop-shadow(0 0 12px rgba(16, 60, 207, 0.6)) drop-shadow(0 0 24px rgba(116, 188, 214, 0.4));
            }

            25% {
                filter: drop-shadow(0 0 16px rgba(239, 120, 140, 0.6)) drop-shadow(0 0 28px rgba(201, 121, 238, 0.5));
            }

            50% {
                filter: drop-shadow(0 0 14px rgba(255, 0, 0, 0.6)) drop-shadow(0 0 26px rgba(168, 85, 247, 0.4));
            }

            75% {
                filter: drop-shadow(0 0 18px rgba(201, 121, 238, 0.7)) drop-shadow(0 0 30px rgba(239, 120, 140, 0.5));
            }
        }

        .icon-wrapper img,
        .icon-wrapper svg {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
        }

        .icon-wrapper.svg-wrapper svg {
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 1;
        }

        .icon-wrapper.img-wrapper img {
            filter: drop-shadow(0 0 8px rgba(16, 60, 207, 0.5));
            opacity: 1;
            transform-origin: center center;
            will-change: transform, opacity;
        }

        body.gemini-mode .icon-wrapper.img-wrapper img {
            animation: ai-logo-breathe 2.5s ease-in-out infinite, ai-logo-pulse 4s ease-in-out infinite;
            filter: drop-shadow(0 0 12px rgba(16, 60, 207, 0.6)) drop-shadow(0 0 24px rgba(116, 188, 214, 0.4));
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 17px;
            font-weight: 600;
            padding: 16px;
            font-family: var(--font);
            color: var(--text-primary);
            letter-spacing: -0.2px;
            -webkit-app-region: no-drag;
            caret-color: var(--accent);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1),
                font-weight 0.6s cubic-bezier(0.33, 1, 0.68, 1),
                letter-spacing 0.6s cubic-bezier(0.16, 1, 0.3, 1),
                color 0.6s cubic-bezier(0.33, 1, 0.68, 1);
        }

        input::placeholder {
            color: var(--text-tertiary);
            font-weight: 400;
            transition: all 0.7s cubic-bezier(0.16, 1, 0.3, 1),
                color 0.7s cubic-bezier(0.33, 1, 0.68, 1),
                font-weight 0.7s cubic-bezier(0.16, 1, 0.3, 1),
                opacity 0.7s cubic-bezier(0.33, 1, 0.68, 1);
        }

        body.gemini-mode input {
            font-weight: 400;
            letter-spacing: 0;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1),
                font-weight 0.6s cubic-bezier(0.33, 1, 0.68, 1),
                letter-spacing 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body.gemini-mode input::placeholder {
            background: linear-gradient(90deg,
                    rgba(116, 188, 214, 0.9) 0%,
                    rgba(168, 85, 247, 0.9) 30%,
                    rgba(239, 120, 140, 0.9) 60%,
                    rgba(116, 188, 214, 0.9) 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: ai-placeholder-shimmer 3s cubic-bezier(0.33, 1, 0.68, 1) infinite;
            font-weight: 500;
        }

        @keyframes ai-placeholder-shimmer {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        input::selection {
            background: rgba(136, 192, 255, 0.3);
        }

        body.gemini-mode input::selection {
            background: rgba(168, 85, 247, 0.25);
        }

        .divider {
            height: 1px;
            background: var(--border-subtle);
            margin: 0 16px;
            opacity: 0;
            transform: scaleX(0.5);
            transition: opacity 0.5s var(--ease-smooth),
                transform 0.5s var(--ease-out);
        }

        .divider.visible {
            opacity: 1;
            transform: scaleX(1);
        }

        #results {
            padding: 8px;
            opacity: 0;
            animation: fadeIn 0.15s var(--ease-out) forwards;
        }

        #results:empty {
            padding: 0;
            animation: none;
        }

        .result-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 10px 14px;
            margin: 2px 0;
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
            color: inherit;
            font-family: inherit;
            -webkit-app-region: no-drag;
            opacity: 0;
            transform: translateY(-6px);
            animation: fadeSlideIn 0.25s var(--ease-out) forwards;
            transition: all 0.15s var(--ease-smooth),
                transform 0.1s var(--ease-smooth);
        }

        .result-item:hover {
            background: var(--hover-bg);
        }

        .result-item:active {
            background: var(--active-bg);
            transform: scale(0.99);
        }

        .result-item.selected {
            background: rgba(201, 121, 238, 0.1);
            box-shadow: inset 0 0 0 1px rgba(201, 121, 238, 0.25);
        }

        .file-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.04);
            flex-shrink: 0;
        }

        .file-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-secondary);
            stroke-width: 1.5;
            fill: none;
        }

        .file-icon.app-icon svg {
            stroke: #88c0ff;
            fill: rgba(136, 192, 255, 0.15);
        }

        .file-icon.folder-icon svg {
            stroke: #f5c542;
            fill: rgba(245, 197, 66, 0.15);
        }

        .file-icon.image-icon svg {
            stroke: #e879f9;
            fill: rgba(232, 121, 249, 0.15);
        }

        .file-icon.code-icon svg {
            stroke: #4ade80;
            fill: rgba(74, 222, 128, 0.15);
        }

        .file-icon.document-icon svg {
            stroke: #fb923c;
            fill: rgba(251, 146, 60, 0.15);
        }

        .file-icon.default-icon svg {
            stroke: #94a3b8;
            fill: rgba(148, 163, 184, 0.1);
        }

        .result-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .result-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: -0.1px;
        }

        .result-path {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-action {
            font-size: 11px;
            color: var(--text-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.04);
            opacity: 0;
            transition: opacity 0.15s var(--ease-smooth);
        }

        .result-item:hover .result-action {
            opacity: 1;
        }

        #gemini-response {
            padding: 16px 20px;
            font-size: 14px;
            line-height: 1.65;
            color: var(--text-primary);
            display: none;
            opacity: 0;
            transform: translateY(8px);
        }

        #gemini-response.visible {
            display: block;
            animation: fadeSlideIn 0.3s var(--ease-out) forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loader-wrapper {
            display: none;
            justify-content: center;
            padding: 24px;
            opacity: 0;
            animation: fadeIn 0.2s var(--ease-out) forwards;
        }

        .loader-wrapper.visible {
            display: flex;
        }

        .loader {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        #no-results {
            display: none;
            padding: 32px 20px;
            text-align: center;
            color: var(--text-tertiary);
            font-size: 14px;
        }

        .results-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .results-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .results-wrapper::-webkit-scrollbar-thumb {
            background: rgba(201, 121, 238, 0.2);
            border-radius: 3px;
        }

        .results-wrapper::-webkit-scrollbar-thumb:hover {
            background: rgba(201, 121, 238, 0.35);
        }

        @keyframes fadeSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .search-stats {
            display: none;
            padding: 6px 16px;
            font-size: 11px;
            color: var(--text-tertiary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .search-stats.visible {
            display: flex;
            align-items: center;
            gap: 12px;
            animation: fadeIn 0.2s var(--ease-out);
        }

        .search-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .hint {
            font-size: 10px;
            color: var(--text-tertiary);
            opacity: 0;
            transition: opacity 0.15s var(--ease-smooth);
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.03);
            white-space: nowrap;
        }

        .result-item:hover .hint {
            opacity: 1;
        }

        .result-hints {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .input-hint {
            position: absolute;
            right: 16px;
            font-size: 11px;
            color: var(--text-tertiary);
            opacity: 0.6;
            pointer-events: none;
            transition: all 0.2s var(--ease-smooth);
        }

        .search-wrapper {
            position: relative;
        }

        svg {
            opacity: 1 !important;
        }

        .settings-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.15s;
            -webkit-app-region: no-drag;
            opacity: 0.4;
        }

        body.gemini-mode .settings-btn {

            opacity: 1;
        }

        .settings-btn:hover {
            background: var(--hover-bg);
            opacity: 1;
        }

        .settings-btn svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-secondary);
            fill: none;
            stroke-width: 2;
        }

        .settings-panel {
            display: none;
            padding: 24px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 0 0 15px 15px;
            animation: settings-reveal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes settings-reveal {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-panel.visible {
            display: block;
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .settings-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .close-settings {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(0, 0, 0, 0.03);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            -webkit-app-region: no-drag;
        }

        .close-settings:hover {
            background: rgba(0, 0, 0, 0.08);
            transform: rotate(90deg);
        }

        .close-settings svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-secondary);
            fill: none;
            stroke-width: 2.5;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-form input[type="text"],
        .settings-form select {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-primary);
            font-family: var(--font);
            outline: none;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        .settings-form input:focus,
        .settings-form select:focus {
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .shake-animation {
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            50% {
                transform: translateX(5px);
            }

            75% {
                transform: translateX(-5px);
            }
        }

        .shake-animation {
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            50% {
                transform: translateX(5px);
            }

            75% {
                transform: translateX(-5px);
            }
        }

        .checkbox-group {
            margin-top: 4px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            user-select: none;
            position: relative;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            height: 20px;
            width: 20px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-container:hover input~.checkmark {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .checkbox-container input:focus-visible~.checkmark,
        .checkbox-container input:focus~.checkmark {
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px var(--primary);
        }

        .checkbox-container input:checked~.checkmark {
            background-color: var(--primary);
        }

        .checkmark:after {
            content: "";
            display: none;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2.5px 2.5px 0;
            transform: rotate(45deg);
            margin-bottom: 2px;
        }

        .checkbox-container input:checked~.checkmark:after {
            display: block;
        }

        .settings-buttons {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            -webkit-app-region: no-drag;
        }

        .settings-buttons button {
            flex: 1;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            font-family: var(--font);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save {
            background: var(--primary);
            border: none;
            color: #fff;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
        }

        .btn-save:hover {
            background: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.3);
        }

        .btn-cancel {
            background: #f1f1f1;
            border: none;
            color: var(--text-secondary);
        }

        .btn-cancel:hover {
            background: #e5e5e5;
            color: var(--text-primary);
        }

        .settings-saved {
            display: none;
            font-size: 13px;
            font-weight: 500;
            color: #10b981;
            text-align: center;
            padding: 8px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            animation: fadeIn 0.3s ease-out;
        }

        .settings-saved.visible {
            display: block;
        }

        /* === Google Search Container - Pre-loaded & Hidden === */
        .google-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease-out;
            box-shadow: 0 -4px 20px rgba(201, 121, 238, 0.15);
            display: flex;
            flex-direction: column;
            -webkit-app-region: no-drag;
            opacity: 0;
            pointer-events: none;
        }

        /* Pre-loaded but hidden state - webview is rendered offscreen */
        .google-container.preloaded {
            position: fixed;
            left: -9999px;
            top: -9999px;
            width: 100%;
            height: 500px;
            opacity: 0;
            pointer-events: none;
        }

        /* Visible state - bring into view */
        .google-container.visible {
            position: absolute;
            left: 0;
            top: auto;
            height: calc(100% - 56px);
            border-radius: 12px 12px 0 0;
            opacity: 1;
            pointer-events: auto;
        }

        #googleWebview {
            flex: 1;
            width: 100%;
            min-height: 400px;
            border: none;
            bottom: 0;
            background: rgba(255, 255, 255, 1);
            transition: opacity 0.2s ease-out;
        }

        .google-container.visible #googleWebview {
            animation: webview-reveal 0.3s ease-out;
        }

        @keyframes webview-reveal {
            from {
                opacity: 0.5;
                transform: scale(0.98);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Loading indicator for webview */
        .google-container.loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 24px;
            height: 24px;
            margin: -12px 0 0 -12px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            z-index: 10;
        }

        #googleWebview::before {
            content: 'Searching...';
            color: #3a3d41;
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: -1;
            background-color: white;



        }

        /* Google mode indicator */
        body.google-mode .spotlight {
            background-image:
                radial-gradient(circle, white 70%, rgb(255, 255, 255)),
                conic-gradient(#EA4335 0deg 90deg,
                    /* Top: Red */
                    #FBBC05 90deg 180deg,
                    /* Right: Yellow */
                    #34A853 180deg 270deg,
                    /* Bottom: Green */
                    #4285F4 270deg 360deg
                    /* Left: Blue */
                );
            background-origin: border-box;
            background-clip: padding-box, border-box;
            border: 4px solid transparent;
            border-radius: 50px;
            outline-offset: 3px;
            transition: all 0.6s var(--ease-out),
                border-radius 0.6s var(--ease-out),
                border 0.6s var(--ease-out);
        }
    </style>
</head>

<body>
    <div class="spotlight">
        <div class="search-wrapper">

            <div class="search-icon" id="searchIcon">
                <div class="icon-wrapper svg-wrapper">
                    <svg viewBox="0 0 24 24" id="searchSvg">
                        <circle cx="11" cy="11" r="7"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                </div>
                <div class="icon-wrapper img-wrapper">
                    <img src="venesa-asset://logo.png" width="36px" height="36px" id="aiSvg" />
                </div>
            </div>
            <input type="text" id="searchInput" placeholder="Search, / for AI, // for Google" autofocus
                spellcheck="false" />
            <button class="settings-btn" id="voiceBtn" title="Voice Mode (Ctrl+Shift+V)">
                <svg viewBox="0 0 24 24">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </button>
            <button class="settings-btn" id="settingsBtn" title="Settings">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
            </button>
        </div>

        <div class="divider" id="divider"></div>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <h2>Settings</h2>
                <button class="close-settings" id="closeSettings" title="Close Settings">
                    <svg viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="settings-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="settingsUserName">Your Name</label>
                        <input type="text" id="settingsUserName" placeholder="Enter your name" />
                    </div>
                </div>

                <div class="form-group checkbox-group">
                    <label class="checkbox-container">
                        <input type="checkbox" id="settingsAutoStart" />
                        <span class="checkmark"></span>
                        Launch Venesa at startup
                    </label>
                </div>

                <div class="settings-buttons">
                    <button class="btn-cancel" id="cancelSettings">Cancel</button>
                    <button class="btn-save" id="saveSettingsBtn">Save Changes</button>
                </div>
                <p class="settings-saved" id="settingsSaved">
                    Settings saved successfully!
                </p>
            </div>
        </div>

        <div class="search-stats" id="searchStats">
            <span id="resultCount">0 results in total</span>
            <span id="searchTime">0.00s</span>
        </div>

        <div class="results-wrapper" id="resultsWrapper">
            <div class="loader-wrapper" id="loader">
                <div class="loader"></div>
            </div>
            <div id="results"></div>
            <div id="gemini-response"></div>
            <div id="no-results">No results found</div>
        </div>

        <!-- Google Search Container (// mode) -->
        <div class="google-container" id="googleContainer">

            <webview id="googleWebview" partition="persist:google"></webview>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById("searchInput");
        const resultsDiv = document.getElementById("results");
        const geminiResponse = document.getElementById("gemini-response");
        const loader = document.getElementById("loader");
        const noResults = document.getElementById("no-results");
        const divider = document.getElementById("divider");
        const resultsWrapper = document.getElementById("resultsWrapper");
        const searchIcon = document.getElementById("searchIcon");
        const searchSvg = document.getElementById("searchSvg");
        const aiSvg = document.getElementById("aiSvg");
        const searchStats = document.getElementById("searchStats");
        const resultCountEl = document.getElementById("resultCount");
        const searchTimeEl = document.getElementById("searchTime");

        const settingsBtn = document.getElementById("settingsBtn");
        const settingsPanel = document.getElementById("settingsPanel");
        const closeSettingsBtn = document.getElementById("closeSettings");
        const cancelSettingsBtn = document.getElementById("cancelSettings");
        const saveSettingsBtn = document.getElementById("saveSettingsBtn");
        const settingsUserName = document.getElementById("settingsUserName");
        const settingsSaved = document.getElementById("settingsSaved");

        // Google search elements
        const googleContainer = document.getElementById("googleContainer");
        const googleWebview = document.getElementById("googleWebview");

        let debounceTimer;
        let selectedIndex = -1;
        let resultItems = [];
        let lastQuery = "";
        let pendingQuery = "";
        let settingsOpen = false;
        let isGeminiAction = false;
        let isAIMode = false;
        let isGoogleMode = false;
        let searchStartTime = 0;
        let googleWebviewReady = false;
        let googlePreloadAttempted = false;
        let googleNavigating = false;


        const setAIMode = (enabled) => {
            isAIMode = enabled;

            if (enabled) {
                requestAnimationFrame(() => {
                    document.body.classList.add("gemini-mode");
                    searchInput.placeholder = "Ask me anything...";
                });
            } else {
                requestAnimationFrame(() => {
                    document.body.classList.remove("gemini-mode");
                    searchInput.placeholder = "Search, / for AI, // for Google";
                });
            }
        };

        const setGoogleMode = (enabled) => {
            isGoogleMode = enabled;
            if (enabled) {
                requestAnimationFrame(() => {
                    document.body.classList.add("google-mode");
                    searchInput.placeholder = "Search Google...";
                });
            } else {
                requestAnimationFrame(() => {
                    document.body.classList.remove("google-mode");
                    closeGoogleSearch();
                });
            }
        };

        // Pre-load Google webview on startup for instant search
        const preloadGoogleWebview = () => {
            if (googlePreloadAttempted || googleNavigating) return;
            googlePreloadAttempted = true;
            googleNavigating = true;

            // Move container offscreen but keep it rendered
            googleContainer.classList.add('preloaded');

            // Load Google homepage to warm up the webview
            try {
                googleWebview.src = 'https://www.google.com/?igu=1';
            } catch (e) {
                console.warn('[Venesa] Google webview pre-load src set failed:', e);
            }

            const onFinish = () => {
                googleNavigating = false;
                googleWebviewReady = true;
                console.log('[Venesa] Google webview pre-loaded and ready');
            };

            const onFail = (e) => {
                googleNavigating = false;
                // ERR_ABORTED is expected if we interrupt, don't warn about it
                if (e.errorCode !== -3) {
                    console.warn('[Venesa] Google webview pre-load failed:', e.errorDescription);
                }
            };

            googleWebview.addEventListener('did-finish-load', onFinish, { once: true });
            googleWebview.addEventListener('did-fail-load', onFail, { once: true });
        };

        const openGoogleSearch = (query) => {
            const searchQuery = encodeURIComponent(query);
            const searchUrl = `https://www.google.com/search?q=${searchQuery}&igu=1`;

            // Stop any ongoing navigation first
            try {
                if (googleNavigating) {
                    googleWebview.stop();
                }
            } catch (e) { }

            googleNavigating = true;

            // Remove preloaded class and show immediately
            googleContainer.classList.remove('preloaded');
            googleContainer.classList.add('visible', 'loading');

            // Navigate to search
            try {
                googleWebview.src = searchUrl;
            } catch (e) {
                console.warn('[Venesa] Google search navigation failed:', e);
                googleNavigating = false;
            }

            // Remove loading state when page loads
            const onLoad = () => {
                googleContainer.classList.remove('loading');
                googleNavigating = false;
            };

            const onFail = () => {
                googleContainer.classList.remove('loading');
                googleNavigating = false;
            };

            googleWebview.addEventListener('did-finish-load', onLoad, { once: true });
            googleWebview.addEventListener('did-fail-load', onFail, { once: true });

            // Expand window height for Google results (Max height)
            window.api.send("resize-window", HEIGHTS.MAX);
        };

        const closeGoogleSearch = () => {
            googleContainer.classList.remove("visible", "expanded", "loading");

            // Stop any ongoing navigation
            try {
                if (googleNavigating) {
                    googleWebview.stop();
                    googleNavigating = false;
                }
            } catch (e) { }

            // Move back offscreen (don't reload - just keep cached state)
            googleContainer.classList.add('preloaded');
        };

        // Pre-load Google webview when app starts (delay to let app stabilize)
        setTimeout(preloadGoogleWebview, 2000);

        // Google container controls
        // Expand button removed per user request

        // Handle external links in webview
        googleWebview.addEventListener("new-window", (e) => {
            e.preventDefault();
            window.api.send("open-external-url", e.url);
        });

        googleWebview.addEventListener("will-navigate", (e) => {
            // Validate URL using proper URL parsing
            try {
                const url = new URL(e.url);
                const hostname = url.hostname;
                // Only allow google.com domains
                if (hostname === "google.com" || hostname.endsWith(".google.com")) {
                    return; // Allow navigation
                }
            } catch (parseError) {
                // Invalid URL, block navigation
            }
            // Block non-Google URLs and open externally
            e.preventDefault();
            window.api.send("open-external-url", e.url);
        });

        const HEIGHTS = {
            BASE: 60,
            SETTINGS_PANEL: 340,
            LOADER: 120,
            NO_RESULTS: 130,
            RESULT_ITEM: 58,
            RESULT_PADDING: 70,
            GEMINI_MIN: 150,
            MAX: 500,
        };

        const spotlightEl = document.querySelector(".spotlight");
        const searchWrapperEl = document.querySelector(".search-wrapper");
        let measuredBaseHeight = HEIGHTS.BASE;

        const safePx = (value) => {
            const n = Number.parseFloat(value);
            return Number.isFinite(n) ? n : 0;
        };

        const recomputeBaseHeight = () => {
            try {
                if (!spotlightEl || !searchWrapperEl) return;
                const spotStyle = getComputedStyle(spotlightEl);
                const borderY =
                    safePx(spotStyle.borderTopWidth) +
                    safePx(spotStyle.borderBottomWidth);

                const dividerStyle = getComputedStyle(divider);
                const dividerY =
                    divider.getBoundingClientRect().height +
                    safePx(dividerStyle.marginTop) +
                    safePx(dividerStyle.marginBottom);

                const searchY = searchWrapperEl.getBoundingClientRect().height;
                const next = Math.ceil(searchY + dividerY + borderY);
                if (Number.isFinite(next) && next > 0) {
                    measuredBaseHeight = next;
                }
            } catch { }
        };

        const getBaseHeight = () => {
            if (!Number.isFinite(measuredBaseHeight) || measuredBaseHeight <= 0) {
                recomputeBaseHeight();
            }
            return measuredBaseHeight;
        };

        window.addEventListener("resize", () => {
            recomputeBaseHeight();
        });

        window.api.receive("focus-input", () => {
            clearTimeout(debounceTimer);

            selectedIndex = -1;
            resultItems = [];
            lastQuery = "";
            pendingQuery = "";
            isGeminiAction = false;
            settingsOpen = false;
            isAIMode = false;
            isGoogleMode = false;

            document.body.classList.remove("gemini-mode", "google-mode");
            searchIcon.classList.remove("ai-active");
            // Note: Icon visibility is controlled by CSS via body.gemini-mode class
            // Do NOT set style.display directly as it conflicts with CSS transitions
            searchInput.placeholder = "Search, / for AI, // for Google";

            searchInput.value = "";

            divider.classList.remove("visible");
            loader.classList.remove("visible");
            loader.style.display = "none";
            resultsDiv.innerHTML = "";
            geminiResponse.style.display = "none";
            geminiResponse.classList.remove("visible");
            geminiResponse.textContent = "";
            noResults.style.display = "none";
            searchStats.classList.remove("visible");
            settingsPanel.classList.remove("visible");
            resultsWrapper.classList.add("collapsed");
            closeGoogleSearch();

            searchInput.focus();
            recomputeBaseHeight();
            window.api.send("resize-window", getBaseHeight());
        });

        const updateWindowHeight = () => {
            requestAnimationFrame(() => {
                recomputeBaseHeight();
                let targetHeight = getBaseHeight();

                if (settingsPanel.classList.contains("visible")) {
                    // Calculate dynamic height based on settings panel content
                    const panelHeight = settingsPanel.offsetHeight;
                    targetHeight = Math.max(HEIGHTS.SETTINGS_PANEL, getBaseHeight() + panelHeight);
                    window.api.send("resize-window", targetHeight);
                    return;
                }

                if (loader.classList.contains("visible")) {
                    targetHeight = HEIGHTS.LOADER + getBaseHeight();
                    resultsWrapper.classList.remove("collapsed");
                    window.api.send("resize-window", targetHeight);
                    return;
                }

                const resultCount = resultsDiv.children.length;
                if (resultCount > 0) {
                    const resultsHeight =
                        HEIGHTS.RESULT_PADDING + resultCount * HEIGHTS.RESULT_ITEM;
                    targetHeight = Math.min(resultsHeight, HEIGHTS.MAX) + 40;
                    resultsWrapper.classList.remove("collapsed");
                    window.api.send("resize-window", targetHeight);
                    return;
                }

                if (geminiResponse.classList.contains("visible")) {
                    const contentHeight = geminiResponse.scrollHeight;
                    targetHeight = Math.min(
                        Math.max(
                            HEIGHTS.GEMINI_MIN,
                            getBaseHeight() + 20 + contentHeight
                        ),
                        HEIGHTS.MAX
                    );
                    resultsWrapper.classList.remove("collapsed");
                    window.api.send("resize-window", targetHeight);
                    return;
                }

                if (noResults.style.display === "block") {
                    targetHeight = HEIGHTS.NO_RESULTS;
                    resultsWrapper.classList.remove("collapsed");
                    window.api.send("resize-window", targetHeight);
                    return;
                }

                resultsWrapper.classList.add("collapsed");
                window.api.send("resize-window", getBaseHeight());
            });
        };

        const hideContent = () => {
            divider.classList.remove("visible");
            loader.classList.remove("visible");
            loader.style.display = "none";
            resultsDiv.innerHTML = "";
            geminiResponse.style.display = "none";
            geminiResponse.classList.remove("visible");
            geminiResponse.textContent = "";
            noResults.style.display = "none";
            searchStats.classList.remove("visible");
            settingsPanel.classList.remove("visible");
            settingsOpen = false;
            selectedIndex = -1;
            resultItems = [];
            isGeminiAction = false;
            resultsWrapper.classList.add("collapsed");
            closeGoogleSearch();
            updateWindowHeight();
        };

        const showLoader = () => {
            divider.classList.add("visible");
            loader.style.display = "flex";
            loader.classList.add("visible");
            resultsDiv.innerHTML = "";
            geminiResponse.style.display = "none";
            geminiResponse.classList.remove("visible");
            noResults.style.display = "none";
            resultsWrapper.classList.remove("collapsed");
            updateWindowHeight();
        };

        const getFolderIcon = () => {
            return '<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>';
        };

        const getFileIcon = (fileName) => {
            const ext = fileName.split(".").pop().toLowerCase();
            const icons = {
                folder:
                    '<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>',
                image:
                    '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',
                document:
                    '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>',
                code: '<svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>',
                default:
                    '<svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>',
            };

            const imageExts = [
                "jpg",
                "jpeg",
                "png",
                "gif",
                "svg",
                "webp",
                "bmp",
                "ico",
            ];
            const codeExts = [
                "js",
                "ts",
                "jsx",
                "tsx",
                "py",
                "html",
                "css",
                "json",
                "xml",
                "java",
                "cpp",
                "c",
                "h",
                "cs",
                "php",
                "rb",
                "go",
                "rs",
                "swift",
            ];
            const docExts = [
                "doc",
                "docx",
                "pdf",
                "txt",
                "md",
                "rtf",
                "xls",
                "xlsx",
                "ppt",
                "pptx",
            ];

            if (imageExts.includes(ext))
                return { icon: icons.image, class: "image-icon" };
            if (codeExts.includes(ext))
                return { icon: icons.code, class: "code-icon" };
            if (docExts.includes(ext))
                return { icon: icons.document, class: "document-icon" };
            return { icon: icons.default, class: "default-icon" };
        };

        const updateSelection = () => {
            resultItems.forEach((item, i) => {
                item.classList.toggle("selected", i === selectedIndex);
            });
        };

        const openSelectedFile = () => {
            if (selectedIndex >= 0 && resultItems[selectedIndex]) {
                resultItems[selectedIndex].click();
            }
        };

        searchInput.addEventListener("input", (e) => {
            const query = e.target.value.trim();

            clearTimeout(debounceTimer);

            selectedIndex = -1;
            resultItems = [];

            // Check for Google mode (// prefix)
            const googleModeTriggered = query.startsWith("//");
            const aiModeTriggered = !googleModeTriggered && (query.startsWith("/") || query.startsWith(">"));

            setGoogleMode(googleModeTriggered);
            setAIMode(aiModeTriggered);

            if (!query) {
                lastQuery = "";
                pendingQuery = "";
                hideContent();
                return;
            }

            if (googleModeTriggered || aiModeTriggered) {
                resultsDiv.innerHTML = "";
                searchStats.classList.remove("visible");
                geminiResponse.style.display = "none";
                geminiResponse.classList.remove("visible");
                noResults.style.display = "none";
                updateWindowHeight();
                return;
            }

            showLoader();
            searchStartTime = performance.now();
            pendingQuery = query;

            debounceTimer = setTimeout(() => {
                if (pendingQuery === query) {
                    lastQuery = query;
                    window.api.send("perform-action", {
                        actionName: "searchFiles",
                        params: { query },
                    });
                }
            }, 500);
        });

        searchInput.addEventListener("keydown", (e) => {
            if (e.key === "ArrowDown") {
                e.preventDefault();
                if (resultItems.length > 0) {
                    selectedIndex = Math.min(selectedIndex + 1, resultItems.length - 1);
                    updateSelection();
                    resultItems[selectedIndex]?.scrollIntoView({ block: "nearest" });
                }
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                if (resultItems.length > 0) {
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSelection();
                    resultItems[selectedIndex]?.scrollIntoView({ block: "nearest" });
                }
            } else if (e.key === "Enter") {
                e.preventDefault();
                if (selectedIndex >= 0) {
                    openSelectedFile();
                } else if (searchInput.value.trim()) {
                    const query = searchInput.value.trim();

                    // Google mode (// prefix)
                    if (isGoogleMode && query.startsWith("//")) {
                        const googleQuery = query.substring(2).trim();
                        if (googleQuery) {
                            openGoogleSearch(googleQuery);
                        }
                    }
                    // AI mode (/ prefix)
                    else if (isAIMode && (query.startsWith("/") || query.startsWith(">"))) {
                        const aiQuery = query.substring(1).trim();
                        if (aiQuery) {
                            showLoader();
                            searchStartTime = performance.now();
                            isGeminiAction = true; // Flag to preserve action-result handling
                            window.api.send("send-to-gemini", aiQuery);
                        }
                    } else if (!isAIMode && !isGoogleMode && resultItems.length > 0) {
                        selectedIndex = 0;
                        openSelectedFile();
                    }
                }
            } else if (e.key === "Escape") {
                searchInput.value = "";
                setAIMode(false);
                setGoogleMode(false);
                hideContent();
            }
        });

        const getAppIcon = () => {
            return '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect></svg>';
        };

        // XSS prevention helper - escape HTML special characters
        const escapeHtml = (text) => {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        window.api.receive("action-result", (result) => {
            loader.classList.remove("visible");
            loader.style.display = "none";

            const wasGeminiAction = isGeminiAction;
            isGeminiAction = false;

            if (!wasGeminiAction) {
                const currentQuery = searchInput.value.trim();
                if (
                    !currentQuery ||
                    currentQuery.startsWith(">") ||
                    currentQuery !== lastQuery
                ) {
                    hideContent();
                    return;
                }
            }

            try {
                const data = JSON.parse(result);

                if (data && data.notFound === true) {
                    showAIResponse(`Not found.`);
                    return;
                }

                if (
                    data &&
                    typeof data === "object" &&
                    (data.apps !== undefined ||
                        data.files !== undefined ||
                        data.folders !== undefined)
                ) {
                    const apps = data.apps || [];
                    const files = data.files || [];
                    const folders = data.folders || [];

                    resultsDiv.innerHTML = "";
                    geminiResponse.style.display = "none";
                    geminiResponse.classList.remove("visible");

                    if (
                        apps.length === 0 &&
                        files.length === 0 &&
                        folders.length === 0
                    ) {
                        noResults.style.display = "block";
                        divider.classList.add("visible");
                        updateWindowHeight();
                        return;
                    }

                    noResults.style.display = "none";
                    resultItems = [];
                    selectedIndex = 0;
                    let itemIndex = 0;

                    const totalResults = apps.length + files.length + folders.length;
                    const searchDuration = (
                        (performance.now() - searchStartTime) /
                        1000
                    ).toFixed(2);
                    resultCountEl.textContent =
                        totalResults +
                        (totalResults === 1 ? " result in total" : " results in total");
                    searchTimeEl.textContent = searchDuration + "s";
                    searchStats.classList.add("visible");

                    const maxTotal = 20;
                    let remainingSlots = maxTotal;

                    const appsToShow = apps.slice(0, remainingSlots);
                    appsToShow.forEach((app) => {
                        const item = document.createElement("button");
                        item.className = "result-item";
                        item.style.animationDelay = itemIndex * 40 + "ms";

                        item.innerHTML =
                            '<div class="file-icon app-icon">' +
                            getAppIcon() +
                            '</div><div class="result-content"><div class="result-name">' +
                            escapeHtml(app.name) +
                            '</div><div class="result-path">Application</div></div>' +
                            '<div class="result-hints"><span class="hint">Enter to launch</span></div>';

                        item.addEventListener("click", () => {
                            window.api.send("launch-app", app);
                        });

                        resultsDiv.appendChild(item);
                        resultItems.push(item);
                        itemIndex++;
                    });

                    remainingSlots -= appsToShow.length;

                    const foldersToShow = folders.slice(0, remainingSlots);
                    foldersToShow.forEach((folderPath) => {
                        const folderName = folderPath.split(/[\\/]/).pop();
                        const parentPath =
                            folderPath.substring(
                                0,
                                folderPath.lastIndexOf(/[\\/]/.exec(folderPath)?.[0] || "\\")
                            ) || folderPath;

                        const item = document.createElement("button");
                        item.className = "result-item";
                        item.style.animationDelay = itemIndex * 40 + "ms";

                        item.innerHTML =
                            '<div class="file-icon folder-icon">' +
                            getFolderIcon() +
                            '</div><div class="result-content"><div class="result-name">' +
                            escapeHtml(folderName) +
                            '</div><div class="result-path">' +
                            escapeHtml(parentPath) +
                            "</div></div>" +
                            '<div class="result-hints"><span class="hint">Click open</span><span class="hint">Right-click location</span></div>';

                        item.addEventListener("click", () => {
                            window.api.send("open-folder", folderPath);
                        });

                        item.addEventListener("contextmenu", (e) => {
                            e.preventDefault();
                            window.api.send("show-file-in-folder", folderPath);
                        });

                        resultsDiv.appendChild(item);
                        resultItems.push(item);
                        itemIndex++;
                    });

                    remainingSlots -= foldersToShow.length;

                    files.slice(0, remainingSlots).forEach((filePath) => {
                        const fileName = filePath.split(/[\\/]/).pop();
                        const dirPath =
                            filePath.substring(
                                0,
                                filePath.lastIndexOf(/[\\/]/.exec(filePath)?.[0] || "\\")
                            ) || filePath;

                        const fileIconData = getFileIcon(fileName);

                        const item = document.createElement("button");
                        item.className = "result-item";
                        item.style.animationDelay = itemIndex * 40 + "ms";

                        item.innerHTML =
                            '<div class="file-icon ' +
                            fileIconData.class +
                            '">' +
                            fileIconData.icon +
                            '</div><div class="result-content"><div class="result-name">' +
                            escapeHtml(fileName) +
                            '</div><div class="result-path">' +
                            escapeHtml(dirPath) +
                            "</div></div>" +
                            '<div class="result-hints"><span class="hint">Click open</span><span class="hint">Right-click location</span></div>';

                        item.addEventListener("click", () => {
                            window.api.send("open-file", filePath);
                        });

                        item.addEventListener("contextmenu", (e) => {
                            e.preventDefault();
                            window.api.send("show-file-in-folder", filePath);
                        });

                        resultsDiv.appendChild(item);
                        resultItems.push(item);
                        itemIndex++;
                    });

                    updateSelection();
                    divider.classList.add("visible");
                    updateWindowHeight();
                } else if (Array.isArray(data)) {
                    resultsDiv.innerHTML = "";
                    geminiResponse.style.display = "none";
                    geminiResponse.classList.remove("visible");

                    if (data.length === 0) {
                        noResults.style.display = "block";
                        divider.classList.add("visible");
                        updateWindowHeight();
                        return;
                    }

                    noResults.style.display = "none";
                    resultItems = [];
                    selectedIndex = 0;

                    const searchDuration = (
                        (performance.now() - searchStartTime) /
                        1000
                    ).toFixed(2);
                    resultCountEl.textContent =
                        data.length + (data.length === 1 ? " result" : " results");
                    searchTimeEl.textContent = searchDuration + "s";
                    searchStats.classList.add("visible");

                    const items = data.slice(0, 20);
                    items.forEach((filePath, i) => {
                        const fileName = filePath.split(/[\\/]/).pop();
                        const dirPath =
                            filePath.substring(
                                0,
                                filePath.lastIndexOf(/[\\/]/.exec(filePath)?.[0] || "\\")
                            ) || filePath;

                        const fileIconData = getFileIcon(fileName);

                        const item = document.createElement("button");
                        item.className = "result-item";
                        item.style.animationDelay = i * 40 + "ms";

                        item.innerHTML =
                            '<div class="file-icon ' +
                            fileIconData.class +
                            '">' +
                            fileIconData.icon +
                            '</div><div class="result-content"><div class="result-name">' +
                            escapeHtml(fileName) +
                            '</div><div class="result-path">' +
                            escapeHtml(dirPath) +
                            "</div></div>" +
                            '<div class="result-hints"><span class="hint">Click open</span><span class="hint">Right-click location</span></div>';

                        item.addEventListener("click", () => {
                            window.api.send("open-file", filePath);
                        });

                        item.addEventListener("contextmenu", (e) => {
                            e.preventDefault();
                            window.api.send("show-file-in-folder", filePath);
                        });

                        resultsDiv.appendChild(item);
                        resultItems.push(item);
                    });

                    updateSelection();

                    divider.classList.add("visible");
                    updateWindowHeight();
                } else {
                    showAIResponse(result);
                }
            } catch (err) {
                showAIResponse(result);
            }
        });

        window.api.receive("gemini-response", (response) => {
            loader.classList.remove("visible");
            loader.style.display = "none";

            if (response) {
                showAIResponse(response);
            }
        });

        function showAIResponse(text) {
            loader.classList.remove("visible");
            loader.style.display = "none";

            resultsDiv.innerHTML = "";
            noResults.style.display = "none";
            resultsWrapper.classList.remove("collapsed");

            if (searchStartTime > 0) {
                const searchDuration = (
                    (performance.now() - searchStartTime) /
                    1000
                ).toFixed(2);
                resultCountEl.textContent = "AI response";
                searchTimeEl.textContent = searchDuration + "s";
                searchStats.classList.add("visible");
            }

            geminiResponse.textContent = text;
            geminiResponse.style.display = "block";
            geminiResponse.classList.add("visible");
            divider.classList.add("visible");

            updateWindowHeight();
        }

        const showSettingsPanel = (settings) => {
            loader.classList.remove("visible");
            loader.style.display = "none";
            resultsDiv.innerHTML = "";
            geminiResponse.style.display = "none";
            geminiResponse.classList.remove("visible");
            geminiResponse.textContent = "";
            noResults.style.display = "none";
            searchStats.classList.remove("visible");
            resultsWrapper.classList.add("collapsed");
            selectedIndex = -1;
            resultItems = [];
            isGeminiAction = false;

            settingsOpen = true;
            settingsUserName.value = settings.userName || "User";
            const settingsAutoStart = document.getElementById("settingsAutoStart");

            if (settingsAutoStart) settingsAutoStart.checked = settings.openAtLogin !== false;

            settingsSaved.classList.remove("visible");
            settingsPanel.classList.add("visible");
            divider.classList.add("visible");
            updateWindowHeight();
        };

        const hideSettingsPanel = () => {
            settingsOpen = false;
            settingsPanel.classList.remove("visible");
            settingsSaved.classList.remove("visible");
            divider.classList.remove("visible");
            resultsWrapper.classList.add("collapsed");
            recomputeBaseHeight();
            updateWindowHeight();
        };

        settingsBtn.addEventListener("click", () => {
            if (settingsOpen) {
                hideSettingsPanel();
            } else {
                window.api.send("get-settings");
            }
        });

        // Voice button handler
        const voiceBtn = document.getElementById("voiceBtn");
        voiceBtn.addEventListener("click", () => {
            window.api.send("open-voice-window");
        });

        closeSettingsBtn.addEventListener("click", () => hideSettingsPanel());
        cancelSettingsBtn.addEventListener("click", () => hideSettingsPanel());

        saveSettingsBtn.addEventListener("click", () => {
            const settingsAutoStart = document.getElementById("settingsAutoStart");
            const nameVal = settingsUserName.value.trim();

            // Validate forbidden names
            if (nameVal.toLowerCase() === "user") {
                // Show temporary error feedback by shaking the input or similar
                settingsUserName.style.borderColor = "var(--accent2)";
                settingsUserName.classList.add("shake-animation"); // Assuming CSS class or just style

                // Reset style after animation
                setTimeout(() => {
                    settingsUserName.style.borderColor = "var(--border-subtle)";
                    settingsUserName.classList.remove("shake-animation");
                }, 500);

                // Ideally show a message, but for minimal changes we just block it
                // Or update the saved success message to be an error
                settingsSaved.textContent = "Please choose a specific name.";
                settingsSaved.style.color = "#ef788c"; // Error color
                settingsSaved.classList.add("visible");

                setTimeout(() => {
                    settingsSaved.classList.remove("visible");
                    settingsSaved.textContent = "Settings saved successfully!"; // Restore default text
                    settingsSaved.style.color = "#10b981"; // Restore success color
                }, 2000);

                return;
            }

            const settings = {
                userName: nameVal || "Venesa User",
                openAtLogin: settingsAutoStart ? settingsAutoStart.checked : true
            };

            window.api.send("save-settings", settings);
        });

        window.api.receive("current-settings", (settings) => {
            showSettingsPanel(settings);
        });

        window.api.receive("settings-saved", (success) => {
            if (success) {
                settingsSaved.classList.add("visible");
                setTimeout(() => {
                    hideSettingsPanel();
                }, 1500);
            }
        });

        window.api.receive("set-input", (data) => {
            // data can be a string (query) or object {query, triggerSearch}
            const text = typeof data === 'string' ? data : data.query;
            const shouldTrigger = typeof data === 'string' ? true : data.trigger; // Default to triggering search

            if (text) {
                searchInput.value = text;
                searchInput.focus();

                // Check for Google mode first (// prefix) to avoid matching single slash
                if (text.startsWith("//")) {
                    setGoogleMode(true);
                    setAIMode(false);
                    searchInput.style.color = "var(--primary)";
                } else if (text.startsWith("/")) {
                    setAIMode(true);
                    setGoogleMode(false);
                    searchInput.style.color = "var(--primary)";
                } else {
                    setAIMode(false);
                    setGoogleMode(false);
                    searchInput.style.color = "var(--text-primary)";
                }

                if (shouldTrigger) {
                    // Manually trigger the 'input' event to run the debounced search logic
                    const event = new Event('input', { bubbles: true });
                    searchInput.dispatchEvent(event);
                }
            }
        });

        updateWindowHeight();
    </script>
</body>

</html>